// g16WPIDML | (c) 2018 GHIFARI160, all rights reserved | https://github.com/Ghifari160/g16WPIDML/blob/master/LICENSE.md
!function(obj){var requestFileSystem=obj.webkitRequestFileSystem||obj.mozRequestFileSystem||obj.requestFileSystem;function on_error(message){alert(message)}var URL,model=(URL=obj.webkitURL||obj.mozURL||obj.URL,{getEntries:function(file,on_end){zip.createReader(new zip.BlobReader(file),function(zipReader){zipReader.getEntries(on_end)},on_error)},getEntryFile:function(entry,creation_method,on_end,on_progress){var writer,zipFileEntry,callback;function getData(){entry.getData(writer,function(blob){var blobURL="Blob"==creation_method?URL.createObjectURL(blob):zipFileEntry.toURL();on_end(blobURL)},on_progress)}"Blob"==creation_method?(writer=new zip.BlobWriter,getData()):(callback=function(fileEntry){zipFileEntry=fileEntry,writer=new zip.FileWriter(zipFileEntry),getData()},requestFileSystem(TEMPORARY,4194304,function(filesystem){function create(){filesystem.root.getFile(tmpFile_name,{create:!0},function(zipFile){callback(zipFile)})}filesystem.root.getFile(tmpFile_name,null,function(entry){entry.remove(create,create)},create)}))}});!function(){var file_input=document.getElementById("g16_wpidml_idml_upload"),result_div=document.getElementById("g16_wpidml_idml_menu");var isReady=!1,blob_data={};var textframes=[],selected_uids=[];function next_to_wizard3(event){event.preventDefault();var result_children=result_div.getElementsByTagName("input"),table=document.createElement("table");table.setAttribute("border",1),table.setAttribute("cellspacing",0),table.setAttribute("cellspadding",0);var tr=document.createElement("tr"),td1=document.createElement("td");td1.innerHTML="Order #",tr.appendChild(td1);var td2=document.createElement("td");td2.innerHTML="Text Frame Content",tr.appendChild(td2),table.appendChild(tr);for(var n=1,i=0;i<result_children.length;i++){var current_element=result_children[i];if("checkbox"==current_element.getAttribute("type")&&current_element.checked){var current_element_id_fragments=current_element.getAttribute("id").split("_"),current_uid=current_element_id_fragments[current_element_id_fragments.length-1];selected_uids.push(current_uid),(tr=document.createElement("tr")).setAttribute("id","g16_wpidml_idml_menu_row_"+i),td1=document.createElement("td");var input=document.createElement("input");input.setAttribute("type","text"),input.setAttribute("maxlength","3"),input.setAttribute("id","g16_wpidml_idml_menu_order_"+i),input.setAttribute("value",n++),td1.appendChild(input),tr.appendChild(td1),(td2=document.createElement("td")).innerHTML=current_element.parentNode.parentNode.childNodes[1].childNodes[0].innerHTML,tr.appendChild(td2),table.appendChild(tr)}}result_div.innerHTML="";var p=document.createElement("p");p.innerHTML="Reorder the following text frames",result_div.appendChild(p),result_div.appendChild(table);var button=document.createElement("button");button.setAttribute("id","g16_wpidml_menu_nextbtn"),button.innerHTML="Generate Post",button.addEventListener("click",next_to_wizardDone),result_div.appendChild(button)}function next_to_wizardDone(){event.preventDefault();for(var ordered_uids=[],post_str="",result_children=result_div.getElementsByTagName("input"),i=0;i<result_children.length;i++){var current_element=result_children[i],current_element_id_fragments=current_element.getAttribute("id").split("_"),current_uid=current_element_id_fragments[current_element_id_fragments.length-1];"text"==current_element.getAttribute("type")&&(ordered_uids[current_element.value-1]=current_uid)}for(i=0;i<ordered_uids.length;i++)post_str+=textframes[ordered_uids[i]];result_div.innerHTML="";var p=document.createElement("p");p.innerHTML="Happy editing!<br><br>";var a1=document.createElement("a");a1.setAttribute("href","https://github.com/ghifari160/wpidml"),a1.setAttribute("target","g16wpidml_tab"),a1.innerHTML="g16WPIDML",p.appendChild(a1),p.innerHTML+=" by ";var a2=document.createElement("a");a2.setAttribute("href","https://github.com/ghifari160"),a2.setAttribute("target","g16wpidml_tab"),a2.innerHTML="GHIFARI160",p.appendChild(a2),result_div.appendChild(p),document.getElementById("content-html").click(),document.getElementById("content").value=post_str,document.getElementById("content-tmce").click()}function parseIDML(){if(isReady){isReady&&"application/vnd.adobe.indesign-idml-package"==blob_data.mimetype||error_fileIsNotIDML();var parser=new DOMParser;for(var key in blob_data){var key_paths=key.split("/");if(1<key_paths.length&&"Stories"==key_paths[0]){var story_name_fragments=key_paths[1].split("_");if(1<story_name_fragments.length&&"Story"==story_name_fragments[0]){story_name_fragments[1];for(var xml_str=blob_data[key],story_paragraphs=parser.parseFromString(xml_str,"text/xml").getElementsByTagName("ParagraphStyleRange"),story_string="",i=0;i<story_paragraphs.length;i++){for(var paragraph_string="<p>",paragraph_characters=story_paragraphs[i].getElementsByTagName("CharacterStyleRange"),j=0;j<paragraph_characters.length;j++){"Bold"==paragraph_characters[j].getAttribute("FontStyle")?paragraph_string+="<strong>":"Italic"==paragraph_characters[j].getAttribute("FontStyle")&&(paragraph_string+="<em>");for(var characters_children=paragraph_characters[j].childNodes,k=0;k<characters_children.length;k++)"Content"==characters_children[k].nodeName?paragraph_string+=characters_children[k].firstChild.nodeValue:"Br"==characters_children[k].nodeName&&(paragraph_string+="<br>");"Bold"==paragraph_characters[j].getAttribute("FontStyle")?paragraph_string+="</strong>":"Italic"==paragraph_characters[j].getAttribute("FontStyle")&&(paragraph_string+="</em>")}story_string+=paragraph_string+="</p>"}"<p></p>"!=story_string&&textframes.push(story_string)}}}!function(){result_div.innerHTML="";var table=document.createElement("table");table.setAttribute("border",1),table.setAttribute("cellspacing",0),table.setAttribute("cellspadding",0);for(var i=0;i<textframes.length;i++){var tr=document.createElement("tr");tr.setAttribute("id","g16_wpidml_idml_menu_row_"+i);var td1=document.createElement("td"),checkbox=document.createElement("input");checkbox.setAttribute("type","checkbox"),checkbox.setAttribute("id","g16_wpidml_idml_menu_checkbox_"+i),td1.appendChild(checkbox),tr.appendChild(td1);var td2=document.createElement("td");100<textframes[i].length?td2.innerHTML=textframes[i].substr(0,100)+"...":td2.innerHTML=textframes[i],tr.appendChild(td2),table.appendChild(tr)}var p=document.createElement("p");p.innerHTML="Select any text frames to include them in the post (you will reorder them in the next screen)",result_div.appendChild(p),result_div.appendChild(table);var button=document.createElement("button");button.setAttribute("id","g16_wpidml_menu_nextbtn"),button.innerHTML="Next",button.addEventListener("click",next_to_wizard3),result_div.appendChild(button)}()}else setTimeout(parseIDML,1e3)}function error_fileIsNotIDML(){result_div.innerHTML="";var p=document.createElement("p");p.innerHTML="Invalid file. Accepted format: IDML",result_div.appendChild(p)}file_input.addEventListener("change",function(){if(isReady=!1,file_input.disabled=!0,file=file_input.files[0],"idml"!=(name_fragments=file.name.split("."))[name_fragments.length-1].toLowerCase())return error_fileIsNotIDML(),void(file_input.disabled=!1);var file,name_fragments;model.getEntries(file_input.files[0],function(entries){result_div.innerHTML="";var i=0;entries.forEach(function(entry){model.getEntryFile(entry,"Blob",function(blobURL){var xhr=new XMLHttpRequest;xhr.open("GET",blobURL,!0),xhr.responseType="blob",xhr.onload=function(e){if(200==this.status){var blob=this.response,blob_reader=new FileReader;blob_reader.addEventListener("loadend",function(){blob_data[entry.filename]=blob_reader.result,blob_data.length=i+1,i==entries.length-1&&(file_input.parentNode.removeChild(file_input),isReady=!0,parseIDML()),i++}),blob_reader.readAsText(blob)}},xhr.send()})})})},!1)}()}(this);
